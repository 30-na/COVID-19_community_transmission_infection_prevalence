---
title: "Kruskal-Wallis Test for Compair mean of Rt number in CDC Risk level Group (21 days later)"
author: "Sina Mokhtar"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



```{r echo = F, message=FALSE, warning = F}
library(dplyr)
library(ggplot2)
library(car)
library(FSA)
library(knitr)
library(kableExtra)
library(ggpubr)

# Load CovidActNow Data and NCHS Data
load("RawData/CovidActNow.rda")
load("ProcessedData/county.NCHS.RDA")


# Clean and Merged Data
data = covid_data %>%
  dplyr::select(
    date,
    state,
    county,
    "fips_code" = fips,
    # R_t, or the estimated number of infections arising from a typical case
    "infection_rate" = metrics.infectionRate,
    #  Enum: 0 1 2 3 4 Community transmission level for region, calculated using the CDC definition.
    # Possible values:  0: Low - 1: Moderate - 2: Substantial - 3: High - 4: Unknown
    cdcTransmissionLevel
  ) %>%
  dplyr::mutate(
    cdcTransmissionLevel = case_when(
      cdcTransmissionLevel == 0 ~ "Low",
      cdcTransmissionLevel == 1 ~ "Moderate",
      cdcTransmissionLevel == 2 ~ "Substantial",
      cdcTransmissionLevel == 3 ~ "High",
      cdcTransmissionLevel == 4 ~ NA_character_,
      TRUE ~ NA_character_
    ),
    cdcTransmissionLevel = factor(cdcTransmissionLevel,
                                  levels = c("Low", "Moderate", "Substantial", "High")), 
    date = as.Date(date, format = "%y-%m-%d"),
    cdcTransmissionLevel = factor(
      cdcTransmissionLevel,
      levels = c("Low", "Moderate", "Substantial", "High")
    )
  ) %>%
  left_join(county.NCHS,
            by = c("fips_code", "state")) %>%
  na.omit(cdcTransmissionLevel,
          UR_category)%>%
  group_by(county, state) %>%
  mutate(mean_last_7_days = zoo::rollmean(infection_rate, k = 7, fill = NA, align = "right"),
         Rt3NextWeeks = lead(mean_last_7_days, 21))
```

## Mean and Median for each group (21 days later)

```{r echo = F, warning=F}
sampleSize = data %>%
  group_by(cdcTransmissionLevel) %>%
  count() %>%
  rename("Counties" = n)

table_data <- data %>% 
  group_by(cdcTransmissionLevel)%>%
  summarize(Rtmean = mean(Rt3NextWeeks, na.rm = T),
            Rtmedian = median(Rt3NextWeeks, na.rm = T),
            RtVariance = var(Rt3NextWeeks, na.rm = T)) %>%
  left_join(sampleSize, by = "cdcTransmissionLevel")%>%
  arrange(Rtmean)

kable(table_data,
      caption = "Summary statistics by CDC transmission level",
      align = "l")%>%
  kableExtra::kable_styling(latex_options = "hold_position")

```


## ANOVA Assumptions (Homogeneity of variances across groups) (21 days later)

### Levene’s Test
The Levene’s Test is a statistical test used to evaluate the equality of variances of a continuous variable across different groups or categories.

```{r echo = F}
# reject constant variance assumption if p-value of the test is less than 0.05

leveneTest(Rt3NextWeeks ~ cdcTransmissionLevel,
data=data)
```

The null hypothesis of the test is that the variances of the Rt3NextWeeks variable are equal across all levels of the cdcTransmissionLevel variable. If the p-value is less than 0.05, we reject the null hypothesis and conclude that the variances are not equal.

In our case, the p-value is less than 0.05 (< 2.2e-16), which means we can reject the null hypothesis and conclude that the variances of Rt3NextWeeks are not equal across all levels of cdcTransmissionLevel. Therefor we use Kruskal-Wallis test



## Kruskal-Wallis test (21 days later)
The Kruskal-Wallis test is a nonparametric statistical test used to determine whether three or more independent groups have different medians. It is an alternative to the one-way ANOVA test, which assumes that the data are normally distributed and have equal variances. The Kruskal-Wallis test is more appropriate when these assumptions are not met.

```{r echo = F}
kruskal.test(Rt3NextWeeks ~ cdcTransmissionLevel,
data=data)

```

The output of the test suggests that the p-value is less than the significance level of 0.05, indicating strong evidence against the null hypothesis that there are no differences between the groups. Therefore, we can conclude that there is a significant difference in the distribution of the Rt3NextWeeks variable across the four levels of cdcTransmissionLevel.



```{r echo = F, warning =F}

# Create a boxplot with separate colors for each CDC transmission level
ggplot(data, aes(x = cdcTransmissionLevel, y = Rt3NextWeeks, fill = cdcTransmissionLevel)) +
  geom_boxplot(alpha=.7) +
  scale_fill_manual(values = c("#4393c3", "#ffffbf", "#fdae61", "#d73027" )) +
  labs(x = "CDC Transmission Level", y = "Rt (last 7 days Average)", 
       title = "Distribution of Rt by CDC transmission level (21 days later)") +
  theme_bw()+
  stat_kruskal_test()
```


## Dunn’s Test (21 days later)

If the results of a Kruskal-Wallis test are statistically significant, then it’s appropriate to conduct Dunn’s Test to determine exactly which groups are different.
```{r echo = F}
#perform Dunn's Test with Bonferroni correction for p-values
dunnTest = dunnTest(Rt3NextWeeks ~ cdcTransmissionLevel,
         data=data,
         method="bonferroni")
dunnTest
```

it looks like all of the pairwise comparisons have very small adjusted p-values, which means that the differences between the levels are statistically significant.
The group with the highest mean is the Low transmission group, followed by the Moderate transmission group, then the High transmission group, and finally the Substantial transmission group with the lowest mean.




## Apply Kruskal-Wallis test for each NCHS category (21 days later)


```{r echo = F, warning=F,  results = "asis"}
UR_category <- unique(data$UR_category)

for(i in UR_category){
  print(i)
  cat("\n")
sampleSize = data %>%
  filter(UR_category == i)%>%
  group_by(cdcTransmissionLevel) %>%
  count() %>%
  rename("Counties" = n)

table_data <- data %>%
  filter(UR_category == i) %>%

  group_by(cdcTransmissionLevel)%>%
  summarize(Rtmean = mean(Rt3NextWeeks, na.rm = T),
            Rtmedian = median(Rt3NextWeeks, na.rm = T),
            RtVariance = var(Rt3NextWeeks, na.rm = T)) %>%
  left_join(sampleSize, by = "cdcTransmissionLevel")%>%
  arrange(Rtmean)

print(kable(table_data,
      caption = paste("Summary statistics by CDC transmission level in", i , "counties (21 days later)"),
      align = "l")%>%
  kableExtra::kable_styling(latex_options = "hold_position"))
cat("\n")


# Create a boxplot with separate colors for each CDC transmission level
print(ggplot(data %>% filter(UR_category == i),
       aes(x = cdcTransmissionLevel,
           y = Rt3NextWeeks,
           fill = cdcTransmissionLevel,
           group = cdcTransmissionLevel)) +
  geom_boxplot(alpha=.7) +
  scale_fill_manual(values = c("#4393c3", "#ffffbf", "#fdae61", "#d73027" )) +
  labs(x = "CDC Transmission Level", y = "Rt (last 7 days Average)", 
       title = paste("Distribution of Rt by CDC transmission level in", i , "counties (21 days later)")) +
  theme_bw() +
   stat_compare_means(comparisons = combn(levels(data$cdcTransmissionLevel), 2, simplify = FALSE)[c(1, 4, 6)],
                      method="wilcox.test")+
  stat_compare_means())
}

```

