---
title: "Investigating the infection rates in counties categorized under the CDC community transmission levels"
author: "Sina Mokhtar"
output: pdf_document
urlcolor: blue
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Abstract

------------------------------------

In September 2020, the Centers for Disease Control and Prevention (CDC) introduced a framework for monitoring COVID-19 community transmission levels based on four categories: high, substantial, moderate, and low. This framework aimed to reduce the risk of severe illness and healthcare strain by using two key metrics: the total number of new cases per 100,000 persons in the past 7 days and the percentage of positive Nucleic Acid Amplification Test results during the same period. These community transmission levels have been instrumental in guiding setting-specific guidance and layered prevention strategies, such as screening testing in schools and implementing masking policies.


This study focuses on investigating the infection rates in counties categorized under the four different CDC COVID-19 community transmission levels. Additionally, we compare the infection rates of the counties with different risk level three weeks later to evaluate the effectiveness of the community transmission risk level classification in predicting future infection trends.


## METHODS

-------------------------------------

### Data Sources

The data for this study was obtained from the following sources

1- [Covid Act Now API](https://covidactnow.org/data-api): This API provides comprehensive COVID-19 data, including metrics related to transmission risk and infection rates from January 2020 to March 2023. The infection rate (Rt) represents the estimated number of new people that each COVID-positive person will infect.

2- CDC, National Center for Health Statistics [NCHS](https://www.cdc.gov/nchs/data_access/urban_rural.htm) This classification system categorizes counties based on their urban or rural characteristics, providing important contextual information for analyzing COVID-19 transmission patterns.



### Statistical Analysis


```{r echo = F, message=FALSE, warning = F}
library(dplyr)
library(ggplot2)
library(car)
library(FSA)
library(knitr)
library(kableExtra)
library(ggpubr)
library(emmeans)
library(pROC)
library(caret)
library(ROCR)

# Load CovidActNow Data and NCHS Data
load("RawData/CovidActNow.rda")
load("ProcessedData/county.NCHS.RDA")
load("ProcessedData/AUROC_merged.RDA")


# Clean and Merged Data
data = covid_data %>%
  dplyr::select(
    date,
    state,
    county,
    "fips_code" = fips,
    # R_t, or the estimated number of infections arising from a typical case
    "infection_rate" = metrics.infectionRate,
    #  Enum: 0 1 2 3 4 Community transmission level for region, calculated using the CDC definition.
    # Possible values:  0: Low - 1: Moderate - 2: Substantial - 3: High - 4: Unknown
    cdcTransmissionLevel
  ) %>%
  dplyr::mutate(
    cdcTransmissionLevel = case_when(
      cdcTransmissionLevel == 0 ~ "Low",
      cdcTransmissionLevel == 1 ~ "Moderate",
      cdcTransmissionLevel == 2 ~ "Substantial",
      cdcTransmissionLevel == 3 ~ "High",
      cdcTransmissionLevel == 4 ~ NA_character_,
      TRUE ~ NA_character_
    ),
    cdcTransmissionLevel = factor(cdcTransmissionLevel,
                                  levels = c("Low", "Moderate", "Substantial", "High")), 
    date = as.Date(date, format = "%y-%m-%d"),
    cdcTransmissionLevel = factor(
      cdcTransmissionLevel,
      levels = c("Low", "Moderate", "Substantial", "High")
    )
  ) %>%
  left_join(county.NCHS,
            by = c("fips_code", "state")) %>%
  group_by(county, state) %>%
  mutate(mean_last_7_days = ifelse(is.na(infection_rate),
                                   NA,
                                   zoo::rollmean(infection_rate, k = 7, fill = NA, align = "right")),
         Rt3NextWeeks = lead(mean_last_7_days, 21),
         risk_level = case_when(cdcTransmissionLevel == "Low"  ~ 1,
                                cdcTransmissionLevel == "Moderate"  ~ 2,
                                cdcTransmissionLevel == "Substantial"  ~ 3,
                                cdcTransmissionLevel == "High"  ~ 4),
         stateFips = paste(state, fips_code, sep = ",")
  ) %>%
  filter(!is.na(Rt3NextWeeks),
         !is.na(risk_level),
         !is.na(UR_category)
         )
summary(data)
```



These statistics provide an overview of the infection rate values for different risk levels, both in the present and 3 weeks later. They give insights into the mean and median infection rates within each CDC Transmission risk level.

```{r echo = F, warning=F, out.width="50%", out.height="50%", eval=FALSE}
sampleSize = data %>%
  group_by(cdcTransmissionLevel) %>%
  count() %>%
  rename("Counties" = n)

table_data <- data %>% 
  group_by(cdcTransmissionLevel)%>%
  summarize(
            Rtmean = mean(mean_last_7_days, na.rm = T),
            Rtmedian = median(mean_last_7_days, na.rm = T),
            RtVariance= var(mean_last_7_days, na.rm = T),
            Rtmean3NextWeeks = mean(Rt3NextWeeks, na.rm = T),
            Rtmedian3NextWeeks = median(Rt3NextWeeks, na.rm = T),
            RtVariance3NextWeeks= var(Rt3NextWeeks, na.rm = T)
            ) %>%
  left_join(sampleSize, by = "cdcTransmissionLevel")%>%
  arrange(cdcTransmissionLevel) %>%
  select(
    "Risk Level" = cdcTransmissionLevel,
    "Counties" = Counties,
    "Mean Rt" = Rtmean,
    "Mean Rt (3 Weeks)" = Rtmean3NextWeeks,
    "Median Rt" = Rtmedian,
    "Median Rt (3 Weeks)" = Rtmedian3NextWeeks
    )

kable(table_data,
      caption = "Summary statistics by CDC transmission level",
      align = "l")%>%
  kableExtra::kable_styling(latex_options = "hold_position")
```



To determine if there is a significant difference in the distribution of infection rate numbers among counties with different CDC Transmission Risk levels, we used two statistical tests: ANOVA (Analysis of Variance) and Kruskal-Wallis test.  


One-way **ANOVA** model that is used to test whether there is a significant difference in means between the groups defined by the CDC Transmission Risk level. The null hypothesis is that there is no significant difference in means between the groups, and the alternative hypothesis is that at least one group mean is different from the others.


```{r echo = F, warning =F}
## Fit anova model
myfit = aov(mean_last_7_days ~ cdcTransmissionLevel,
data=data)
anova(myfit)
```



```{r echo = F, warning =F}
# Create a boxplot with separate colors for each CDC transmission level
ggplot(data, aes(x = cdcTransmissionLevel, y = mean_last_7_days, fill = cdcTransmissionLevel)) +
  geom_boxplot(alpha=.7) +
  scale_fill_manual(values = c("#4393c3", "#ffffbf", "#fdae61", "#d73027" )) +
  labs(x = "CDC Transmission Level", y = "Rt (last 7 days Average)", 
       title = "Distribution of Rt by CDC transmission level") +
  theme_bw()+
  stat_compare_means(method = "anova")+
  ylim(c(0,3.3))
```

In this case, the p-value is 2e-16, which is smaller than the conventional significance level of 0.05. Therefore, we reject the null hypothesis and conclude that there is a significant difference in means between the groups. To further analyze the specific group differences, we calculate the estimated marginal means, allowing us to identify significant differences among the groups and gain insights into the average response across different groups.

```{r echo = F, warning =F}
# Contrasts to perform pairwise comparisons
cont <-
  emmeans::emmeans(
    myfit
  , specs = "cdcTransmissionLevel"
  )

plot(cont, comparisons = F)+
  theme_bw()+
  labs(title = "Rt estimated marginal means for each CDC risk level")
cont
#cont %>% pairs()
#Tukeyfit <- TukeyHSD(myfit, conf.level=.95)
#Tukeyfit
```


The results show that the Low transmission group has the highest mean, followed by the Moderate and High transmission groups, and the Substantial transmission group has the lowest mean. The p-values for all the groups are very small (p < 0.001), indicating that the differences in means are statistically significant.


```{r echo = F, warning =F}
## Fit anova model
myfit3weeks = aov(Rt3NextWeeks ~ cdcTransmissionLevel,
data=data)

# Contrasts to perform pairwise comparisons
cont3weeks <-
  emmeans::emmeans(
    myfit3weeks
  , specs = "cdcTransmissionLevel"
  )

plot(cont3weeks, comparisons = F)+
  theme_bw()+
  labs(title = "Rt estimated marginal means for each CDC risk level 3 weeks later")
cont3weeks
```

\newpage

The **Kruskal-Wallis** test is a nonparametric statistical test used to determine whether three or more independent groups have different medians. It is an alternative to the one-way ANOVA test, which assumes that the data are normally distributed and have equal variances. Since in our case these assumptions are not met the Kruskal-Wallis test is more appropriate. 

```{r echo = F}
kruskal.test(Rt3NextWeeks ~ cdcTransmissionLevel,
data=data)

```

```{r echo = F, warning =F}
# Create a boxplot with separate colors for each CDC transmission level
plot1 = ggplot(data, aes(x = cdcTransmissionLevel, y = mean_last_7_days, fill = cdcTransmissionLevel)) +
  geom_boxplot(alpha=.7, outlier.shape = NA) +
  scale_fill_manual(values = c("#4393c3", "#ffffbf", "#fdae61", "#d73027" )) +
  labs(x = "CDC Transmission Level", y = "Rt (last 7 days Average)" 
       ,title = "Distribution of Rt by CDC transmission level"
       ) +
  theme_bw()+
  stat_compare_means()+
  ylim(c(0.5,1.5))

plot2 = ggplot(data, aes(x = cdcTransmissionLevel, y = Rt3NextWeeks, fill = cdcTransmissionLevel)) +
  geom_boxplot(alpha=.7) +
  scale_fill_manual(values = c("#4393c3", "#ffffbf", "#fdae61", "#d73027" )) +
  labs(x = "CDC Transmission Level", y = "Rt (last 7 days Average)" 
       ,title = "Distribution of Rt by CDC transmission level at 21 days later"
       ) +
  theme_bw()+
  stat_compare_means()+
  ylim(c(0,3.3))

plot1
plot2
```

The output of the test suggests that the p-value is less than the significance level of 0.05, indicating strong evidence against the null hypothesis that there are no differences between the groups. Therefore, we can conclude that there is a significant difference in the distribution of the Rt number across the four levels of CDC Transmission risk level both at the same day and 21 days later.

Then we applied the Kruskal-Wallis same test in each NCHS category to see if there is significant difference in the distribution of the Rt number across CDC Transmission risk level groups both at the same day and 21 days later.


```{r echo = F, warning=F,  results = "asis",, fig.width=10,fig.height=18}
ggplot(data, aes(x = cdcTransmissionLevel, y = mean_last_7_days, fill = cdcTransmissionLevel)) +
  geom_boxplot(alpha=.7) +
  scale_fill_manual(values = c("#4393c3", "#ffffbf", "#fdae61", "#d73027" )) +
  labs(x = "CDC Transmission Level", y = "Rt (last 7 days Average)" 
       ,title = "Distribution of Rt by CDC transmission level"
       ) +
  theme_bw()+
  ylim(c(0,3.8))+
  stat_compare_means()+
   stat_compare_means(
     comparisons = combn(levels(data$cdcTransmissionLevel), 2, simplify = FALSE)[c(1, 4, 6)],
                      method="wilcox.test"
     )+
  facet_wrap(. ~ UR_category,
             ncol=2)
```

```{r echo = F, warning=F,  results = "asis",, fig.width=10,fig.height=12}
ggplot(data, aes(x = cdcTransmissionLevel, y = Rt3NextWeeks, fill = cdcTransmissionLevel)) +
  geom_boxplot(alpha=.7) +
  scale_fill_manual(values = c("#4393c3", "#ffffbf", "#fdae61", "#d73027" )) +
  labs(x = "CDC Transmission Level", y = "Rt (last 7 days Average)" 
       ,title = "Distribution of Rt by CDC transmission level at 21 days later"
       ) +
  theme_bw()+
  ylim(c(0,3.8))+
  stat_compare_means()+
   stat_compare_means(
     comparisons = combn(levels(data$cdcTransmissionLevel), 2, simplify = FALSE)[c(1, 4, 6)],
                      method="wilcox.test"
     )+
  facet_wrap(. ~ UR_category,
             ncol=2)
```

\newpage


```{r echo = F, warning=F, out.width="50%", out.height="50%"}
sampleSize = data %>%
  group_by(cdcTransmissionLevel,
           UR_category) %>%
  count() %>%
  rename("Counties" = n)

table_data <- data %>% 
  group_by(cdcTransmissionLevel,
           UR_category)%>%
  summarize(
            Rtmean = mean(mean_last_7_days, na.rm = T),
            Rtmedian = median(mean_last_7_days, na.rm = T),
            RtVariance= var(mean_last_7_days, na.rm = T),
            Rtmean3NextWeeks = mean(Rt3NextWeeks, na.rm = T),
            Rtmedian3NextWeeks = median(Rt3NextWeeks, na.rm = T),
            RtVariance3NextWeeks= var(Rt3NextWeeks, na.rm = T)
            )%>%
  left_join(sampleSize, by = c("cdcTransmissionLevel",
                               "UR_category"))%>%
  arrange(UR_category) %>%
  select(UR_category,
    "Risk Level" = cdcTransmissionLevel,
    "Observation" = Counties,
    "Mean Rt" = Rtmean,
    "Mean Rt (3 Weeks)" = Rtmean3NextWeeks,
    "Median Rt" = Rtmedian,
    "Median Rt (3 Weeks)" = Rtmedian3NextWeeks
    )

#kable(table_data,
#      caption = "Summary statistics by CDC transmission level",
#      align = "l")%>%
#  kableExtra::kable_styling(latex_options = "hold_position")


UR_category_list = unique(sampleSize$UR_category)

kbl(table_data,
    caption = "Summary statistics by CDC transmission level",
    booktabs = T) %>%
kableExtra::kable_styling(latex_options = "hold_position") %>%
  pack_rows(UR_category_list[1], 1, 4) %>%
  pack_rows(UR_category_list[2], 5, 8) %>%
  pack_rows(UR_category_list[3], 9, 12) %>%
  pack_rows(UR_category_list[4], 13, 16) %>%
  pack_rows(UR_category_list[5], 17, 20) %>%
  pack_rows(UR_category_list[6], 21, 24)



```



The **AUROC** (Area Under the Receiver Operating Characteristic) is a metric to evaluate the prediction performance. A value closer to 1 suggests a better prediction ability, while a value close to 0.5 indicates random prediction.

To compare the next 21 days expected infection rates with the actual infection rates , we randomly sampled atleast %20 of counties from each UR category risk level for each day. We then compared their infection rates number with other counties of different risk levels in three weeks later.

The expected outcome (0 or 1) was determined based on the following revised criteria:

* If a county is categorized as low-risk, we expect its infection rate 3 weeks later to be lower than the other counties.

* If a county is categorized as medium-risk, we expect its infection rate 3 weeks later to be higher than low-risk counties and lower than substantial and high-risk counties.

* If a county is categorized as substantial-risk, we expect its infection rate 3 weeks later to be lower than high-risk counties and higher than low and medium-risk counties.

* If a county is categorized as high-risk, we expect its infection rate 3 weeks later to be higher than the other counties.  


```{r echo = F, message=FALSE, warning = F}
county_list = county.NCHS %>%
  select(state,
         fips_code,
         UR_code,
         UR_category) %>%
  distinct() %>%
  mutate(
    fips_state = paste(state, fips_code, sep=",")
  ) %>% 
  select(fips_state,
         UR_code,
         UR_category)
  
UR1 = filter(county_list, UR_code == 1)$fips_state
UR2 = filter(county_list, UR_code == 2)$fips_state
UR3 = filter(county_list, UR_code == 3)$fips_state
UR4 = filter(county_list, UR_code == 4)$fips_state
UR5 = filter(county_list, UR_code == 5)$fips_state
UR6 = filter(county_list, UR_code == 6)$fips_state




merged_counties = merged_counties2 %>%
  mutate(
    truePositive = ifelse(expected_higher_rt == 1 & actual_higher_rt == 1, 1, 0),
    falsePositive = ifelse(expected_higher_rt == 1 & actual_higher_rt == 0, 1, 0),
    trueNegative = ifelse(expected_higher_rt == 0 & actual_higher_rt == 0, 1, 0),
    falseNegative = ifelse(expected_higher_rt == 0 & actual_higher_rt == 1, 1, 0)
    )%>%
  na.omit(c(truePositive, falsePositive, trueNegative, falseNegative)) %>%
  mutate(
    target_UR = case_when(
      stateFips %in% UR1 ~ 1,
      stateFips %in% UR2 ~ 2,
      stateFips %in% UR3 ~ 3,
      stateFips %in% UR4 ~ 4,
      stateFips %in% UR5 ~ 5,
      stateFips %in% UR6 ~ 6
    )
  )

apply(merged_counties[23:26], 2, sum) 
```



```{r echo = F, message=FALSE, warning = F}
county1 = filter(merged_counties, UR_code == 1 & target_UR == 1)
county2 = filter(merged_counties, UR_code == 2 & target_UR == 2)
county3 = filter(merged_counties, UR_code == 3 & target_UR == 3)
county4 = filter(merged_counties, UR_code == 4 & target_UR == 4)
county5 = filter(merged_counties, UR_code == 5 & target_UR == 5)
county6 = filter(merged_counties, UR_code == 6 & target_UR == 6)
```



```{r echo = F, warning=F}
# Create the prediction object
pred_obj <- prediction(merged_counties$expected_higher_rt,
                       merged_counties$actual_higher_rt)

# Create the performance object
perf_obj <- performance(pred_obj, "tpr", "fpr")

# Calculate the AUROC
auroc <- performance(pred_obj, "auc")@y.values[[1]]

# Create the ROC curve data frame
roc_data <- data.frame(fpr = unlist(perf_obj@x.values),
                       tpr = unlist(perf_obj@y.values))

# Create the ROC curve plot with AUROC
roc_plot <- ggplot(data = roc_data, aes(x = fpr, y = tpr)) +
  geom_path(color = "#377eb8", size = 1) +
  geom_abline(intercept = 0, slope = 1, linetype = "dashed", color = "black") +
  labs(
    x = "False Positive Rate", y = "True Positive Rate",
       title = "ROC Curve for Evaluating CDC Transmission Risk Level",
       subtitle = paste("AUROC:", round(auroc, 2))) +
  theme_bw() +
  annotate("text", x = 0.8,
           y = 0.2,
           label = paste("AUROC =", round(auroc, 2)), size = 4)

# Print the ROC curve plot
print(roc_plot)
```

In this case an AUC of 29% indicates that the predictive model has limited power, as the AUC is relatively low. The AUC of 29% indicates that the predictive model is not even work as good as a random model. Based on this information, it can be concluded that the CDC Transmission Risk Level performance in predicting the infection rate is not accurate

Then we calculated the AUROC in each NCHS category.



```{r echo = F, warning=F,  results = "asis", fig.width=10, fig.height=12}
# Create the prediction object
pred_obj1 <- prediction(county1$expected_higher_rt,
                       county1$actual_higher_rt)

pred_obj2 <- prediction(county2$expected_higher_rt,
                       county2$actual_higher_rt)

pred_obj3 <- prediction(county3$expected_higher_rt,
                       county3$actual_higher_rt)

pred_obj4 <- prediction(county4$expected_higher_rt,
                       county4$actual_higher_rt)

pred_obj5 <- prediction(county5$expected_higher_rt,
                       county5$actual_higher_rt)

pred_obj6 <- prediction(county6$expected_higher_rt,
                       county6$actual_higher_rt)



# Create the performance object
perf_obj1 <- performance(pred_obj1, "tpr", "fpr")
perf_obj2 <- performance(pred_obj2, "tpr", "fpr")
perf_obj3 <- performance(pred_obj3, "tpr", "fpr")
perf_obj4 <- performance(pred_obj4, "tpr", "fpr")
perf_obj5 <- performance(pred_obj5, "tpr", "fpr")
perf_obj6 <- performance(pred_obj6, "tpr", "fpr")


# Calculate the AUROC
auroc1 <- performance(pred_obj1, "auc")@y.values[[1]]
auroc2 <- performance(pred_obj2, "auc")@y.values[[1]]
auroc3 <- performance(pred_obj3, "auc")@y.values[[1]]
auroc4 <- performance(pred_obj4, "auc")@y.values[[1]]
auroc5 <- performance(pred_obj5, "auc")@y.values[[1]]
auroc6 <- performance(pred_obj6, "auc")@y.values[[1]]



# Create the ROC curve data frame
roc_data1 <- data.frame(fpr = unlist(perf_obj1@x.values),
                       tpr = unlist(perf_obj1@y.values))%>%
  mutate(
    UR_Category = "Large central metro",
    auroc = auroc1
  )

roc_data2 <- data.frame(fpr = unlist(perf_obj2@x.values),
                       tpr = unlist(perf_obj2@y.values))%>%
  mutate(
    UR_Category = "Large fringe metro",
    auroc = auroc2
  )

roc_data3 <- data.frame(fpr = unlist(perf_obj3@x.values),
                       tpr = unlist(perf_obj3@y.values))%>%
  mutate(
    UR_Category = "Medium metro",
    auroc = auroc3
  )

roc_data4 <- data.frame(fpr = unlist(perf_obj4@x.values),
                       tpr = unlist(perf_obj4@y.values))%>%
  mutate(
    UR_Category = "Small metro",
    auroc = auroc4
  )

roc_data5 <- data.frame(fpr = unlist(perf_obj5@x.values),
                       tpr = unlist(perf_obj5@y.values))%>%
  mutate(
    UR_Category = "Micropolitan",
    auroc = auroc5
  )

roc_data6 <- data.frame(fpr = unlist(perf_obj6@x.values),
                       tpr = unlist(perf_obj6@y.values))%>%
  mutate(
    UR_Category = "Noncore",
    auroc = auroc6
  )
roc_data = rbind(
  roc_data1,
  roc_data2,
  roc_data3,
  roc_data4,
  roc_data5,
  roc_data6
)

# Create the ROC curve plot with AUROC
roc_plot <- ggplot(data = roc_data, aes(x = fpr, y = tpr)) +
  geom_path(color = "#377eb8", size = 1) +
  geom_abline(intercept = 0, slope = 1, linetype = "dashed", color = "black") +
  labs(
    x = "False Positive Rate", y = "True Positive Rate",
       title = "ROC Curve for Evaluating CDC Transmission Risk Level") +
  theme_bw() +
  facet_wrap(. ~ UR_Category,
             ncol=2)+
  geom_text(aes(x = 0.8, y = 0.2, label = paste("AUROC =", round(auroc, 2))),
            size = 4, show.legend = FALSE, data = subset(roc_data, !is.na(auroc)))


# Print the ROC curve plot
print(roc_plot)
```

```{r echo = F, warning=F, out.width="50%", out.height="50%" }
sampleSize = merged_counties %>%
  group_by(cdcTransmissionLevel,
           UR_category) %>%
  count() %>%
  rename("Counties" = n)

table_data <- merged_counties %>% 
  group_by(cdcTransmissionLevel,
           UR_category)%>%
  summarize(
            Rtmean = mean(mean_last_7_days, na.rm = T),
            Rtmedian = median(mean_last_7_days, na.rm = T),
            RtVariance= var(mean_last_7_days, na.rm = T),
            Rtmean3NextWeeks = mean(Rt3NextWeeks, na.rm = T),
            Rtmedian3NextWeeks = median(Rt3NextWeeks, na.rm = T),
            RtVariance3NextWeeks= var(Rt3NextWeeks, na.rm = T)
            ) %>%
  left_join(sampleSize, by = "cdcTransmissionLevel")%>%
  arrange(cdcTransmissionLevel) %>%
  select(
    "Risk Level" = cdcTransmissionLevel,
    "UR Category" = UR_category,
    "Counties" = Counties,
    "Mean Rt" = Rtmean,
    "Mean Rt (3 Weeks)" = Rtmean3NextWeeks,
    "Median Rt" = Rtmedian,
    "Median Rt (3 Weeks)" = Rtmedian3NextWeeks
    )






kable(table_data,
      caption = "Summary statistics by CDC transmission level",
      align = "l")%>%
  kableExtra::kable_styling(latex_options = "hold_position")

```



\newpage

```{r echo = F, warning=F,  results = "asis"}
cm = confusionMatrix(factor(merged_counties$expected_higher_rt),
                          factor(merged_counties$actual_higher_rt))
  
# Create the confusion matrix
confusion_matrix <- cm$table

# Convert the confusion matrix to a data frame
confusion_df <- as.data.frame(confusion_matrix)


# Calculate percentage for labels
confusion_df$Percent <- sprintf("%.1f%%", confusion_df$Freq / sum(confusion_df$Freq) * 100)


# Plot the confusion matrix using ggplot2
g = ggplot(confusion_df,
           aes(x = Reference, y = Prediction, fill = Freq)) +
  geom_tile() +
  #geom_text(aes(label = Count), color = "black") +
  geom_text(aes(label = Percent), color = "black", size = 3) +
  scale_fill_gradient(low = "#fff7ec", high = "#ef6548") +
    scale_x_discrete(limits = rev(levels(confusion_df$Reference)),
                     position = "top") +  # Reverse x-axis

  labs(title = paste0("Confusion Matrix for all counties") ,
       x = "Actual",
       y = "Predicted") +
  theme_minimal()+
  guides(fill = FALSE)
g
```


* True Positives (TP): In 317117 cases we expected a higher infection rate number in 3 weeks later compared to other counties, and the actual infection rate number was indeed higher in those cases.

* False Positives (FP): In 509605 cases we expected a higher infection rate number in 3 weeks later compared to other counties, but the actual infection rate number was lower in those cases.

* True Negatives (TN): In 155791 cases we expected a lower infection rate number in 3 weeks later compared to other counties, and the actual infection rate number was indeed lower in those cases.

* False Negatives (FN): In 199487 cases we expected a lower infection rate number in 3 weeks later compared to other counties, but the actual infection rate number was higher in those cases.

**Accuracy**: The overall accuracy of the model is 0.29, which means the model correctly identified 29% of the cases.


Then we calculated the confusion matrix in each NCHS category.


```{r echo = F, warning=F,  results = "asis", fig.width=10, fig.height=12}
cm1 = confusionMatrix(factor(county1$expected_higher_rt),
                          factor(county1$actual_higher_rt))

cm2 = confusionMatrix(factor(county2$expected_higher_rt),
                          factor(county2$actual_higher_rt))

cm3 = confusionMatrix(factor(county3$expected_higher_rt),
                          factor(county3$actual_higher_rt))

cm4 = confusionMatrix(factor(county4$expected_higher_rt),
                          factor(county4$actual_higher_rt))

cm5 = confusionMatrix(factor(county5$expected_higher_rt),
                          factor(county5$actual_higher_rt))

cm6 = confusionMatrix(factor(county6$expected_higher_rt),
                          factor(county6$actual_higher_rt))


  
# Create the confusion matrix
confusion_df1 <- as.data.frame(cm1$table) %>%
  mutate(
    UR_Category = "Large central metro",
    Percent = sprintf("%.1f%%", Freq / sum(Freq) * 100),
    per_num = Freq / sum(Freq) * 100
  )

confusion_df2 <- as.data.frame(cm2$table) %>%
  mutate(
    UR_Category = "Large fringe metro",
    Percent = sprintf("%.1f%%", Freq / sum(Freq) * 100),
    per_num = Freq / sum(Freq) * 100
  )

confusion_df3 <- as.data.frame(cm3$table) %>%
  mutate(
    UR_Category = "Medium metro",
    Percent = sprintf("%.1f%%", Freq / sum(Freq) * 100),
    per_num = Freq / sum(Freq) * 100
  )

confusion_df4 <- as.data.frame(cm4$table) %>%
  mutate(
    UR_Category = "Small metro",
    Percent = sprintf("%.1f%%", Freq / sum(Freq) * 100),
    per_num = Freq / sum(Freq) * 100
  )

confusion_df5 <- as.data.frame(cm5$table) %>%
  mutate(
    UR_Category = "Micropolitan",
    Percent = sprintf("%.1f%%", Freq / sum(Freq) * 100),
    per_num = Freq / sum(Freq) * 100
  )

confusion_df6 <- as.data.frame(cm6$table) %>%
  mutate(
    UR_Category = "Noncore",
    Percent = sprintf("%.1f%%", Freq / sum(Freq) * 100),
    per_num = Freq / sum(Freq) * 100
  )


confusion_df = rbind(confusion_df1,
                     confusion_df2,
                     confusion_df3,
                     confusion_df4,
                     confusion_df5,
                     confusion_df6)



# Plot the confusion matrix using ggplot2
ggplot(confusion_df,
           aes(x = Reference, y = Prediction, fill = per_num)) +
  geom_tile() +
  #geom_text(aes(label = Count), color = "black") +
  geom_text(aes(label = Percent), color = "black", size = 3) +
  scale_fill_gradient(low = "#fff7ec",
                      high = "#ef6548") +
    scale_x_discrete(limits = rev(levels(confusion_df$Reference)),
                     position = "top") +  # Reverse x-axis

  labs(
    #title = paste0("Confusion Matrix for", UR Category, " counties") ,
       x = "Actual",
       y = "Predicted") +
  theme_minimal()+
  guides(fill = FALSE)+
  facet_wrap(. ~ UR_Category,
             ncol=2)


```




